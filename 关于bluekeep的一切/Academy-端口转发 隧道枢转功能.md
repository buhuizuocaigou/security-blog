适用的环境，当攻陷了某一台主机后，需要转移的时候，如何从另外一台主机转移到另外一个内网的主机上，如何找到下一台我们需要攻陷的目标呢？
检查 三点  ·1 privilege level 
           2 network connections  
            3 VPN or other remote access software
观察是否有其他的网络适配器可以帮助我们移动到另外一个玩段中
主要目的是找到不同网段主机内容的地址，并且尝试的去攻击他们 ，去应用他们
打破分段访问内网的方向，搭建隧道机制，将网络流量封装到协议中 伪装协议达到通过路由流量的目的。

及逆行包装  vpn 等 只是进入隧道的一种形式，
### lateral movement  这个指的是横向移动的工具能力
横向移动 旋转 挖隧道 
跨主机的权限提升等问题 ：
横向移动是可以达到跨主机的 提升 ：
比如是应用共享管理员等账户去进行操作学习等  去访问在另外一个域中的数据信息 
https://www.paloaltonetworks.com/cyberpedia/what-is-lateral-movement
https://attack.mitre.org/tactics/TA0008/
总结 ：横向攻击指的是攻击者成功攻击拿下一个主机后，并且尝试访问其他主机的一种技术，和你参观同时保证长时间不被发现，一般横向移动的时候再真实世界中是用避开已知的楼哦都给你跟恶意软件 ，靠自己挖掘信息，
采用无文件攻击技术，比如涉及到那种高级的无文件攻击的技术手段 
一定要达到规避的目的，横向移动重点是一定要让防守者无法感知你的存在，并且规避你的行为跟行动的过程 ，规避方式 ：XDR可以阻止这一切的形成。

### 1 Porxy  Pivoting
多个主机跨越网络。目标是 通过入侵目标主机达到多级跳板多级翻转然后最终入侵的目的。
两种至于奥雷选哪个  可以借助ssh或者某种隧道来代理流量 并且让攻击者访问原本不可能访问的网络设备服务
、
2 VPN Pivoting VPN 的横向移动
受害者系统上搭建一个vpn链接 然后可以借此访问内网 ，然后可以借此实现 vpn调班 实现对内网更深入的渗透方式 ，多级代理搭建逆转

Tunneling ：各种协议将流量传入传出网络 对其协议做一个伪装的部分  HTTB掩盖并且胡晓晓我们行为防止被发现的问题 
指令隐藏在GET跟POST的请求中，并造成混淆的过程，


基础知识 网络概念扎实的基础理解 
IP跟NIC  ： IP由 DHCP 服务器自动获取 
静态ip分配在服务器 路由器 交换机虚拟接口 打印机 
等接口中 ，
NIC  ：是Network Interface vontroller 这工呢，一个计算机可以有多个NIC  可以分配多个IP地址 ，取决于分配特定的IP   一个NIC 配多个IP地址 多个IP地址聚合为同一个 地址

在linux 上通过ifconfig 可以看到 一些跟ip地址有关的信息 
同理在 window上的ipconfig也可以看到 信息来源
对于linux而言  输入 `ifconfig`即可查看对应的ip的地址信息 ，其中分析如下 所示：
![[Pasted image 20241031145629.png]]
在这里 除了eth0 网卡是对外的一个地址外 ，其余的网卡 都是内网的地址信息，并且 在tun0中 这个是 搭载了vpn后的内网地址信息，显示出来了
既 除了eth0链接的网卡外其余的都是内网信息 

子网掩码 是 subnet mask  这个 在window中有体现，并且 在子网掩码中相当于是区号的意思，
默认的网关 既  default Gateway 是告诉你在哪里有那个 NIC 的ip地址可以充当信息的 

Routing 关于路由器：
任何计算机 都可以成为路由器，将 主机流量借助路由器转发机制 嫁接到另外一个地方，路由器的特征死幻哟个路由表，这个路由表揭示了 对应的 IP地址抓饭流量的时候  
这个在 linux中的命令以及查看方式如下：
`netstat -r 或者 ip route`
![[Pasted image 20241031151022.png]]
![[Pasted image 20241031151033.png]]这里信息揭示了  几个点
对于输出的第二章表格如下所示  ：
查看其帮助文档可以发现对应的如下 ：
![[Pasted image 20241031151304.png]]
其中对于-r 解释是 展示了 routing table  也就是转发表，他解释了 是路由器的报文是如何转发的 
具体 的表格解释如下：
对于 netstat 展示的   
Destination ：目的地，目标网络或者主机的ip地址
Gate way （网关）到达目的地所需要的网关地址 如果显示 的是* 表示的是直连的网络
Genmask 子网掩码：定义了网络的部分跟主机部分的掩码，匹配目标网络的iP地址范围 
Flags：U 表示处于活动状态  H 表示是这个主机路由 G表示这个路由通过的网关  D表示路由动态  
MSS最大报文长度  ：TCP链接的时候的最大报文的大小  Windows 指的是TCP的窗口大小
Iface 接口 达到目标网络的接口是用的tun0 还是哪里
注意 直连的标志 Getaway下面是 * 外还可能的是 0.0.0.0

![[Pasted image 20241031151816.png]]
这个 是 以第二行举例 他解释了是 目的地址是10.10.10.0的所有流量 经过10.10.16.1加工后，经过tun0接口发往内网 ，这是个隧道搭建的路径，而 gateway 为0.0.0.0.的地址是直连
除此之外 在这个表上暂时没有或者没有明确指出的协议 走的流量端口均为 default这个路线
并且  如果不是 动态路由协议 比如  EIGRP OSPF BGP等 动态路由协议的话，如果有新的目的ip地址介入 路由表 在不是动态协议的前提下不会更新 

这default 的默认网关是最后手段的网关信息 
画图的工具是draw.io
https://app.diagrams.net/#Hbuhuizuocaigou%2Facademy-proxity%2Fmain%2F%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.drawio#%7B%22pageId%22%3A%22C5RBs43oDa-KdzZeNtuy%22%7D
协议服务跟端口信息 ：
Protocols 管理网络通信的规则，相应的ports 的标识符，并且 逻辑端口是那种逻辑分配的不是物理分配，虚拟化后的分配的端口数。  创造性的使用端口信息，

### 使用SSH跟socks 隧道进行动态端口转发
一 端口转发上下文 ：
poty forwarding 是允许将通信请求从端口a转发到端口b 的一个技术  TCP作为主要的通信层，
OSI的第四层模型 交互的通信 ，但是 可以用不同的应用层协议来封装数据包 
虽然在 TCPIP层但是可以用应用层的协议

攻击场景：攻击机：10.10.16.2
目标机器 ：10.129.xx
场景预设 以及通过前端各种方式成功攻陷此主机内容，并且现在进行进一步探索，
1 利用nmap搜索 在目标机器上的 可能存在的tcp开放端口，并且进行探尝试是否能进行访问， 模拟流程如下：
第一步  namp搜索可用的端口转发号 终极目的是能否借助一个跳板进行跳转到最终主机上，此主机只为一个跳板机 也就是肉鸡
![[Pasted image 20241101094310.png]]
发现 此时目标受害者有 22端口开放ssh  以及80的http服务
![[Pasted image 20241101094525.png]]
发现此时 mysql服务存在
由于我们已知对方靶机上有ssh服务以及账号，所以 此时有两条路线 
路线一 ：将ssh链接进后，并且进行远程访问mysql 
路线二：将其端口转发到攻击机的主机端口xxxx后本地访问 
二者的好处是啥？
答案 若采取路线二的形式，本地访问的时候 如果我们想在mysql执行远程攻击，必须得做端口转发 才可 否则无法进行mysql攻击服务，且mysql本地托管在ubuntu的3306端口上
此时需要进行端口转发服务。

步骤二  执行本地端口转发 
在ssh的man文档中-L选项中可以看到 ：
![[Pasted image 20241101095233.png]]
执行本地端口转发 
`ssh -L 1122:localhost:3306 unbuntu@ip addresses`
执行后 -L 通过文档可以查询到其信息是告诉ssh客户端请求ssh服务，将我们通过端口转发的所有数据信息通过转发到  把原来机器中的3306所在的mysql服务转发到 本地的1122端口号上，
![[Pasted image 20241101145313.png]]


netstat 的man文档如下所示 :其中 我们的目的是为了观察本地端口是否成功嫁接到了1122上  所以我们需要的条件是  
-a 关于socksname 信息全部显示，
-n是把不要显示 名字  host名字 等各种名字 
-t是质的是，tcp链接 
-p 指的是把所有的项目展示PID 就是信息显示更加全面性 
对其进行管道 操作后，我们只需要1122端口上的信息  所以要grep 1122 



![[Pasted image 20241101145854.png]]
这几个命令 解说 -A 指的是显示全部信息，-T表示的时显示TCP信息，-N表示把 ![[Pasted image 20241101151600.png]]
第三列中的localhost变成 数字筛选出来刚刚的 1122端口号即可 

法二 用nmap确认端口转发发生 ：
工具以及信息如下：
为何要用到-sV 答案：因为 -sV揭示了port的具体的version 我们的目的是为了查看本地端口1122号上是否有来自 ssh转发的 mysql服务的流量接口机制
![[Pasted image 20241101152013.png]]
![[Pasted image 20241101152309.png]]
这里揭示了 对应man文档中的-sV 信息 其中提到了 展示版本号所在的信息  

如果为多个端口转发的话可以 
`ssl -L  转发后的本地地址的端口号：攻击机的ip地址：远程ssh链接需要转发的服务的端口号 -L 接着写端口号 ：localhost：原端口服务的地址端口号 用户名@目标ip信息 `
### 设置 Pivot
此时所设置场景：
1 对目标靶机的所属端口服务信息 位置，不知道那些服务存在于端口上 
2 目标 我们想通过一些手段了解到 没有接到外部机器的主机ip地址 既在ens224网卡上的 ip内部地址的所在的服务段有几个 并且都有什么端口连接了什么服务 ，

![[Pasted image 20241101152642.png]]
此时在ssh所连接的端口号中 输入uifcofnig 可以知道 有如下几个ip 
首先 一个接入到我们攻击机的地址 ens192  
其次有个ens224的地址是外部机器无法访问独属于内网的地址
再有就是lo的环回地址信息 

关键点，由于ip为172.16.5.129这个所在的地址信息 不在外网运行，属于内部网络的专属地址故，不可以直接在攻击机上扫描进行，所以
采用的方法是：在unbutu服务器上 执行 dynamic port forwarding 动态端口转发 跟网络数据包，
既然无法在机器上启动，故直接在攻击机上搭建好socks 代理，然后通过ssh服务系统将其转发到内网网段进行操作
以ssh搭建隧道进行穿越的过程 
此过程可以描述如下 ：
在socks情况下 初始的第一段流量由 攻击机发送主动发送到目标机器上然后以此建立链接 ，即为初始的流量通路是 从搭建socks的代理端发出到 目标端 后随即建立起隧道系统 发生

这种手法是用于规避waf逃避防火墙  ，并允许外部实体绕过防火墙直接访问防火墙内网 
好处二：socks 代理可以铜鼓创建爱你从到外部服务器的nat网络直接进行穿透，既直接在本来无法连接外网的 ENSS224网卡段强行开辟一段隧道后，进行尝试访问外部网络的操作

SOCKS 两种类型：
1 SOCKS4 ：不提供任何身份验证跟udp 
2 SOCKS5 ：提供
![[Pasted image 20241101154129.png]]
这些中 注意 socks 代理端，就是通过在sshclient 搭建隧道的时候 借助sock5这个代理服务器的一个工具来伪装并且逃避防火墙的检测机制，在初次ssh从攻击网段发送到内网的网段后，此处双向链接通道已经搭建链接完毕
此由于后续还需要监听  所以采用的手法是动态端口转发

在ssh启动搭建隧道的地址端口9050后，此处这条隧道可以转 发 tor socks 跟http等代理服务器重定向tcp链接，然后对方的机器认为我们主机ip是最后那条跟他通信的链接 ，这样可以隐藏请求的IP地址 ，通过tcp 等多处进行多级跳板代理处理
多级代理链条已达到隐藏源ip地址的目的

所以 我们在ssh端 进行 动态端口转发，来让socks搭建后的 socks 以及http/HTTPs代理能通过咱们搭建好的隧道转发出去 
![[Pasted image 20241101155553.png]]
这里是-D 的信息 其中重点注意 whenever 链接到piort后 可以通过端口转发 并且代理链接
![[Pasted image 20241101162255.png]]
设置4050为隧道端口
此时 隧道搭建完毕 ，需要修改里面的 porxychains 代理的一个配置文件 加入 本地的proxychains 的文件配置文件信息中，
格式是 socks4 127.0.0.1 4050 加入到最后一行或者修改 
这个是要用到的 代理工具信息 ：
https://github.com/haad/proxychains
这里的默认端口信息为9050  ![[Pasted image 20241101162745.png]]
然后我修改为 4050 
这时候利用porxychains 这个 代理 进入后 
![[Pasted image 20241101171240.png]]
其中 在使用的代理连打包的 nmap数据 转发这个方法当中，我们需要注意的是，只能对tcp链接做全部转发  只认这个 其他的一礼拜不认 比如 半联结扫描 ，因为window的deference 默认阻止icmp请求 
在整个网络中不依赖 ping的tcp扫描花费很长时间，所以 本例中不考虑  如果想深入研究的话 
他是 链接如下：
https://nmap.org/book/scan-methods-connect-scan.html

采用如下 代理链条枚举 window目标 ：
![[Pasted image 20241101203601.png]]
寻找对应的端口信息
在尝试 rdp端口存在的时候 ，发现可能利用的rdp端口的店 ，然后去执行msfconsole进一步确认是否存在，挂代理运行 ![[Pasted image 20241101204033.png]]
得知
![[Pasted image 20241101204052.png]]
成功拿下发现有3389上的rdp存在 
所以 
![[Pasted image 20241101204407.png]]
干到内网真他吗快，直接借助 socks端口代理成功建立隧道搭建 隧道穿越功能 get

### 使用ssh进行远程 反向端口转发
 第一个实验 ：本地端口转发 机制，且ssh在本地主机侦听将远程服务器的转发到我们对应的端口上，并且 动态端口抓饭，![[Pasted image 20241101205211.png]]
 适用场景 当进入到windowA 后想从这里 windowA的机器中建立一个反向shell反向链接到 攻击机  
 必须要连接到第三方  
 远程反向端口转发 适用于以下技术：
 1 当上传文件 跟瞎子啊文件在rdp被禁用，或者说是 执行枚举的时候被禁用  只能执行低端api 想提升的
 此时 需要找到一个第三方主机 来充当中间的转接站，然后这个转接站 负责衔接 A 跟C 之间的链接，首先我们确保可以ssh到Ubuntu上  ，在这条隧道中，需要保证反向链接的数据可以从 最终内网的windowA主机 链接到我们的A攻击机上 ，这样构成通路
 而我们已知的条件是 从A攻击机到B 中间机器的过程，所以 需要先开启ubuntu的端口 以便把从C 的反向shell发送到A
 此时 在Metasploit启动侦听器 即可捕获

此时总结 思路 要做如下三件事 ：
1 使用msfvenom 生成一个木马，最终执行要在 window执行 
2 当生成这个木马后再把这个木马从attack 机器转移到第三方ubuntu上 ，然后再移动到window上，
3 为了能接收到来自windwoA 的反弹sehll 故 a需要打开接受的端口号来接受来自C的反弹shell

